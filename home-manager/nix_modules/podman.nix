{ pkgs, lib, config, ... }:
let
  cfg = config.features.podman;
  # Read secrets from repo root (requires git-crypt)
  secrets = builtins.fromJSON (builtins.readFile ../../secrets.json);
in
{
  options.features.podman = {
    enable = lib.mkOption {
      type = lib.types.bool;
      default = config.features.full.enable;
      description = "Enable Podman container tools";
    };
  };

  config = lib.mkIf cfg.enable {
    home.packages = with pkgs; [
      podman
      podman-tui
      skopeo
      buildah
      slirp4netns
      fuse-overlayfs
    ];

    home.activation.createPodmanVolumes = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
      $DRY_RUN_CMD mkdir -p $VERBOSE_ARG \
        "$HOME/.config/ddns-go" \
        "$HOME/dufs"
        # "$HOME/rustfs/data" \
        # "$HOME/rustfs/logs"
    '';


    services.podman = {
      enable = true;
      containers = {
        ddns-go = {
          image = "docker.io/jeessy/ddns-go";
          autoStart = true;
          autoUpdate = "registry";
          network = [ "host" ];
          volumes = [
            "%h/.config/ddns-go:/root"
          ];
          # SECURITY: Use extraConfig to bind to localhost only (avoiding args duplication with ENTRYPOINT)
          extraConfig = {
            Container = {
              Exec = "-l 127.0.0.1:9876 -f 300";
            };
          };
        };
        # rustfs = {
        #   image = "docker.io/rustfs/rustfs:latest";
        #   autoStart = true;
        #   autoUpdate = "registry";
        #   ports = [
        #     "9000:9000"
        #     "9001:9001"
        #   ];
        #   volumes = [
        #     "%h/rustfs/data:/data:U"
        #     "%h/rustfs/logs:/logs:U"
        #   ];
        # };
        dufs = {
          image = "docker.io/sigoden/dufs";
          autoStart = true;
          autoUpdate = "registry";
          # SECURITY: Bind to 127.0.0.1:5005 to be reverse-proxied by Caddy (securely hidden)
          ports = [ "127.0.0.1:5005:5000" ];
          # Mounts the host directory %h/dufs (where %h is home directory) to /data inside the container.
          # To change the host directory, modify the part before the colon: "/path/to/your/files:/data"
          volumes = [ "%h/dufs:/data" ];
          # command = [ "/data" "-A" ];
          # SECURITY: Enable authentication (-a) with admin user
          extraConfig = {
            Container = {
              Exec = "/data -A -a ${secrets.dufs_auth}";
            };
          };
        };
      };
    };

    # Enable the Podman socket for TUI/GUI tools
    systemd.user.sockets.podman = {
      Unit = {
        Description = "Podman API Socket";
      };
      Socket = {
        ListenStream = "%t/podman/podman.sock";
        SocketMode = "0660";
      };
      Install.WantedBy = [ "sockets.target" ];
    };

    # Corresponding service for the socket
    systemd.user.services.podman = {
      Unit = {
        Description = "Podman API Service";
        Requires = [ "podman.socket" ];
        After = [ "podman.socket" ];
      };
      Service = {
        Type = "exec";
        KillMode = "process";
        ExecStart = "${pkgs.podman}/bin/podman system service";
      };
    };

    # DATA FIX:
    # Use drop-in overrides to set PATH, avoiding conflict with the main service file
    # generated by the Podman module.
    home.file.".config/systemd/user/podman-ddns-go.service.d/override.conf".text = ''
      [Service]
      Environment="PATH=/usr/bin:/bin:${lib.makeBinPath [ pkgs.podman ]}"
      # CONFIG: Ensure config file exists to prevent first-run failure
      ExecStartPre=${pkgs.bash}/bin/bash -c '[ -f %h/.config/ddns-go/.ddns_go_config.yaml ] || ${pkgs.coreutils}/bin/touch %h/.config/ddns-go/.ddns_go_config.yaml'
      # CONFIG: Reset password on every start (ensures consistent state)
      ExecStartPre=${pkgs.podman}/bin/podman run --rm -v %h/.config/ddns-go:/root docker.io/jeessy/ddns-go -resetPassword ${secrets.ddns_password}
    '';

    # home.file.".config/systemd/user/podman-rustfs.service.d/override.conf".text = ''
    #   [Service]
    #   Environment="PATH=/usr/bin:/bin:${lib.makeBinPath [ pkgs.podman ]}"
    # '';
    
    home.file.".config/systemd/user/podman-dufs.service.d/override.conf".text = ''
      [Service]
      Environment="PATH=/usr/bin:/bin:${lib.makeBinPath [ pkgs.podman ]}"
    '';
  };
}
